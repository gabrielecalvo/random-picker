<head>
  <link
    rel="icon"
    href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçÄ</text></svg>"
  />
  <script src="https://cdn.plot.ly/plotly-2.8.3.min.js"></script>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
    crossorigin="anonymous"
  />
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
    crossorigin="anonymous"
  ></script>
  <script src="./lib.js"></script>
</head>
<body>
  <!-- Modal -->
  <div class="modal fade" id="addItemModal" tabindex="-1" aria-labelledby="addItemModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addItemModalLabel">Add Item</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="text" id="new-item-input" />
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="new-item-btn" onclick="addItem()">Save changes</button>
        </div>
      </div>
    </div>
  </div>

  <div class="px-4 py-5 my-5 text-center">
    <h1 class="display-5 fw-bold">Random Team Member Picker</h1>
    <div class="col-lg-6 mx-auto">
      <p class="lead mb-4">
        Add team members and pick among them at random. If someone has been picked last time, they are excluded from the
        immediately next pick. Probability of getting picked is <i>inversly proportional</i> to the times they have been
        picked in the past. <br /><br />
        <span id="sourceTypeParagraph"></span>
      </p>

      <div class="d-grid gap-2 d-sm-flex justify-content-sm-center">
        <button type="button" class="btn btn-primary btn-lg px-4" id="pick-btn" onclick="pick()" hidden="true">
          Pick Random Team Member
        </button>
        <button
          type="button"
          class="btn btn-outline-secondary btn-lg px-4 gap-3"
          data-bs-toggle="modal"
          data-bs-target="#addItemModal"
        >
          Add Team Member
        </button>
      </div>

      <div class="m-4 text-center">
        <p id="picked-text"></p>

        <button
          type="button"
          class="btn btn-success btn-lg px-4"
          id="accept-picked"
          onclick="acceptPicked()"
          hidden="true"
        >
          Accept
        </button>
      </div>

      <h3 id="piechart-title" hidden="true">Current probabilities of getting picked</h3>

      <div id="spinner" class="text-center">
        <span class="visually-hidden">Loading...</span>
        <div class="spinner-border" role="status"></div>
      </div>

      <div id="piechart"></div>
    </div>
  </div>

  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 2000">
    <div id="toastElem" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-body"></div>
    </div>
  </div>

  <script>
    let state = {window};
    let interimPicked = null

    function updateView() {
      document.querySelector(".spinner-border").hidden = false
      if (
        typeof state.data !== 'undefined' && 
        Object.keys(state.data.pickCounts).length > 0
      ) {
        document.getElementById("pick-btn").hidden = false;
        document.getElementById("piechart-title").hidden = false;
        lib.createPiePlot(state.data, "piechart");
      }
      // console.log("pickCounts", state.data.pickCounts)
      document.querySelector(".spinner-border").hidden = true
    }

    function makeToast(body){
      const toastElement = document.getElementById('toastElem');
      const toastBody = toastElement.querySelector('div.toast-body');
      toastBody.textContent = body;
      let toast = bootstrap.Toast.getOrCreateInstance(toastElement)
      return toast
    }

    function addItem() {
      const item_name = document.getElementById("new-item-input").value;
      if (state.data.pickCounts.hasOwnProperty(item_name)) {
          makeToast(`üõë "${item_name}" already exists, choose another name`).show()
      } else {
        console.log("adding item", item_name, state.source);
        newState = {
          "data": structuredClone(state.data),
          "source": structuredClone(state.source),
          "window": state.window,
        }
        newState.data.pickCounts[item_name] = 0;
        lib.storeState(newState).then(
          () => {updateView(); makeToast(`üëå item "${item_name}" added successfully`).show()}
        ).catch(
          (err) => {makeToast(`‚ö† an error has occurred when writing the state to storage: ${err}`).show()}
        );
      }
      
    }

    function pick() {
      interimPicked = lib.pickItem(state);
      document.getElementById("picked-text").innerHTML = `Fate chose <b>${interimPicked}</b>. Do you accept or do you want to pick again?`;
      document.getElementById("accept-picked").hidden = false;
      document.getElementById("pick-btn").innerHTML = "Pick Again";
    }

    function acceptPicked() {
      state.data.pickCounts[interimPicked] += 1;
      state.data.lastPicked = interimPicked
      lib.storeState(state).then(
        () => {updateView(); makeToast(`üëå state updated successfully`).show()}
      ).catch(
        (err) => {makeToast(`‚ö† an error has occurred when writing the state to storage: ${err}`).show()}
      );
      
    }

    document.addEventListener("DOMContentLoaded", function(event){
      lib.getDataFromQueryString(state).then(()=> {
        const sourceTypeParagraph = document.getElementById("sourceTypeParagraph")
        if (state.source.type === "remote"){
          sourceTypeParagraph.innerHTML = "<b>Note: </b>you are using a remote storage, any accepted changes will be irreversible."
        } else {
          sourceTypeParagraph.innerHTML = "<b>Note: </b>that the state is saved in the url, <i>so make sure you copy/bookmark it before closing the window.</i>"
        }
        updateView()
      });  
    }) 
  </script>
</body>
